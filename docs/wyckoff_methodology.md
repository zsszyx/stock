# 选股方法论总结：聪明的钱（Smart Money）与威科夫逻辑

## 1. 核心方法论：市场周期的第一性原理

基于《量价分析》与威科夫操盘法，市场的价格波动并非随机，而是由供需关系的不平衡驱动的。这种不平衡通常由“主力资金”（Composite Man）的运作引起。

一个完整的上涨周期通常包含三个阶段：

### 第一阶段：吸筹 (Accumulation)
*   **原理**：主力资金在低位悄悄买入，为了不引起价格过早上涨，他们会利用震荡区间来吸收散户的筹码。
*   **特征**：
    *   **价格形态**：长期横盘，箱体震荡。
    *   **波动率**：极度收缩（Volatility Contraction）。
    *   **成交量**：整体低迷，间歇性出现“量涨价平”或“量跌价平”。

### 第二阶段：测试 (The Test / Spring)
*   **原理**：在正式拉升前，主力需要确认市场中是否还存在大量的浮动供应（卖盘）。
*   **特征**：
    *   **弹簧效应 (Spring)**：价格瞬间击穿支撑位，制造恐慌，清洗最后的意志不坚定者。
    *   **关键信号**：价格创新低但迅速收回（长下影线），且**成交量极低**（说明卖盘枯竭）。

### 第三阶段：启动与标记 (Markup / SOS)
*   **原理**：确供应枯竭后，主力开始主导需求，推动价格突破阻力区。
*   **特征**：
    *   **强势信号 (SOS)**：大阳线突破箱体，伴随成交量显著放大（需求压倒供应）。
    *   **回踩确认 (LPS)**：缩量回踩突破口，确认支撑有效。

---

## 2. 产品需求文档 (PRD)：威科夫爆发前夜选股策略

### 2.1 策略目标
寻找处于 **“吸筹末期”** 或 **“测试完成”** 阶段，即将进入或刚刚进入 **“启动阶段”** 的股票。

### 2.2 核心功能模块

#### 模块 A：结构扫描 (Structure Scanner)
用于识别“吸筹”结构。
*   **波动率收缩 (VCP)**：计算过去 60 个交易日的布林带带宽 (Bandwidth) 或 ATR/Price 比率。要求处于历史低位区间。
*   **趋势过滤**：当前价格位于 200 日均线之上（或 200 日均线走平/向上），确保处于长期多头背景。

#### 模块 B：异动侦测 (Anomaly Detector)
用于识别“测试”或“启动”信号。
*   **KSP 动能因子**：利用本项目独有的 KSP 指标（偏度+峰度）。
    *   **正向异动**：高 KSP 分数代表价格分布出现“肥尾”，即出现了统计学上的异常上涨脉冲。
*   **资金流向 (Net Money Flow)**：
    *   **5日资金净流入**：确保主力资金在近期是净买入状态。

#### 模块 C：综合打分 (Ranking System)
*   不依赖单一指标，而是寻找 **“低波动背景下的高动能爆发”**。
*   **公式**：$Rank = \frac{Momentum (KSP)}{Volatility (ATR)}$
*   **逻辑**：在最安静的时候（低分母），出现了最强烈的异动（高分子）。

### 2.3 技术指标定义
1.  **Volatility (60d)**: $StdDev(Close, 60) / MA(Close, 60)$
2.  **KSP Score**: 现有的 5日/14日 累计 KSP 分数。
3.  **Net Money Flow**: 现有的 5日资金净流入。

---

## 3. 算法实现方案 (奥卡姆剃刀版)

为了避免陷入“参数调优陷阱”，我们将逻辑简化为第一性原理：**“平静后的爆发”**。

我们不需要复杂的形态识别（如识别“W底”或“头肩底”），因为形态千变万化且容易过拟合。我们只需要抓住两个物理特征：
1.  **势能积累 (Potential Energy)** = 长期低波动 (Low Volatility)。
2.  **动能释放 (Kinetic Energy)** = 近期高 KSP 得分 (High KSP Score)。

### 算法伪代码
```python
def select_wyckoff_breakout(date):
    # 1. 基础过滤
    pool = filter(list_days > 180)
    
    # 2. 识别吸筹 (平静期)
    # 计算过去 40-60 天的波动率
    pool['volatility'] = rolling_std(price, 60) / rolling_mean(price, 60)
    # 选取波动率最低的前 30% 股票 (相对阈值，非绝对阈值，适应不同市场环境)
    quiet_stocks = pool.sort('volatility').head(30%)
    
    # 3. 识别启动 (爆发期)
    # 在平静的股票中，寻找 KSP 分数(动能)最高的
    # KSP 分数本身就包含了成交量和价格的异动信息
    targets = quiet_stocks.sort('ksp_sum_5d', ascending=False).head(9)
    
    return targets
```

### 为什么这个算法有效且鲁棒？
1.  **参数极少**：核心参数只有“波动率窗口(60d)”和“排名前百分比(30%)”。
2.  **逻辑自洽**：它捕捉的是**“蓄势 -> 突破”**的物理过程，而不是某一种特定的图形。
3.  **适应性强**：无论牛熊，永远存在“相对平静”后“相对爆发”的股票。

---

## 4. 预期回测计划
我们将基于 `stock` 系统现有的架构，开发 `WyckoffSelector`，并复用 `BTBacktester` 进行验证。
*   **买入**：低波动池中的高 KSP 股，且资金流向为正。
*   **卖出**：KSP 动能衰竭（排名下降）或 止盈止损。
