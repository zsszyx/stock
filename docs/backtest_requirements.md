# 股票量化策略回测需求文档

## 一、回测参数配置

### 1.1 时间参数
| 参数 | 说明 | 示例值 | 状态 |
|------|------|--------|------|
| `start_date` | 回测开始日期 | 2025-01-01 | ✅ |
| `end_date` | 回测结束日期 | 2026-02-19 | ✅ |
| `warm_up_days` | 预热期（用于计算指标） | 60 天 | ✅ |

### 1.2 资金参数
| 参数 | 说明 | 示例值 | 状态 |
|------|------|--------|------|
| `initial_capital` | 初始资金 | 1,000,000 元 | ✅ |
| `position_size` | 单股仓位上限 | 11.11% (9仓) | ✅ |
| `max_positions` | 最大持仓数量 | 9 只 | ✅ |

### 1.3 交易参数
| 参数 | 说明 | 示例值 | 状态 |
|------|------|--------|------|
| `order_type` | 订单类型 | Limit Order | ✅ |
| `limit_price` | 限价价格基准 | POC (Point of Control) | ✅ |
| `stop_loss` | 止损比例 | -2% | ✅ |
| `take_profit` | 止盈比例 | +10% | ✅ |
| `sell_rank_threshold` | 卖出排名阈值 | > 300 | ✅ |

---

## 二、观察指标体系

### 2.1 收益类指标
| 指标 | 说明 | 计算方式 | 状态 |
|------|------|----------|------|
| **总收益率** | 策略整体收益 | (最终资产 - 初始资产) / 初始资产 | ✅ |
| **年化收益率** | 年化后的收益 | (1 + 总收益率)^(250/交易天数) - 1 | ✅ |
| **超额收益** | 策略 vs 基准 | 策略收益率 - 基准收益率 | ✅ |
| **Alpha (α)** | 超额收益（CAPM） | 策略收益 - β × 基准收益 | ✅ |

### 2.2 风险类指标
| 指标 | 说明 | 计算方式 | 状态 |
|------|------|----------|------|
| **最大回撤** | 最大跌幅 | max(Peak - Trough) / Peak | ✅ |
| **波动率** | 收益标准差 | std(日收益率) × √250 | ✅ |
| **夏普比率** | 风险调整收益 | (收益率 - 无风险利率) / 波动率 | ✅ |
| **索提诺比率** | 下行波动率调整 | (收益率 - 目标收益) / 下行波动率 | ✅ |
| **Calmar 比率** | 收益/最大回撤 | 年化收益 / 最大回撤 | ✅ |

### 2.3 交易类指标
| 指标 | 说明 | 计算方式 | 状态 |
|------|------|----------|------|
| **总交易次数** | 买卖总次数 | BUY + SELL | ✅ |
| **买入次数** | 买入动作次数 | COUNT(BUY) | ✅ |
| **卖出次数** | 卖出动作次数 | COUNT(SELL) | ✅ |
| **胜率** | 盈利交易占比 | 盈利次数 / 总交易次数 | ✅ |
| **平均持仓天数** | 股票平均持有时间 | ∑持仓天数 / 交易次数 | ✅ |
| **换手率** | 持仓变动频率 | 交易金额 / 初始资金 | ✅ |

### 2.4 基准对比指标
| 指标 | 说明 | 基准股票 | 状态 |
|------|------|----------|------|
| **Benchmark Return** | 基准收益 | 上证指数 (000001.SH) | ✅ |
| **超额收益** | 策略 - 基准 | - | ✅ |
| **Beta (β)** | 市场敏感度 | - | ✅ |

---

## 三、输出报告要求

### 3.1 图表输出
- [x] **收益曲线对比图** - 策略收益 vs 基准收益（带填充区域）
- [x] **资产配置变化图** - 现金 vs 持仓市值（堆叠面积图）
- [x] **持仓数量变化图** - 持仓股票数量随时间变化
- [x] **回撤曲线图** - 策略回撤随时间变化
- [x] **收益分布直方图** - 日收益率分布

### 3.2 数据输出
- [x] **每日资产表** (`daily_summary.csv`)
  - 日期、现金、持仓市值、总资产、持仓数量
- [x] **交易记录表** (`trades.csv`)
  - 日期、股票代码、买卖方向、价格、数量、金额
- [x] **统计摘要** (`summary.json`)
  - 总收益率、夏普比率、最大回撤、交易次数等

### 3.3 精度要求
- [x] **价格保留小数点后 2 位**
- [x] **金额单位：元**
- [x] **百分比保留 2 位小数**

---

## 四、常见回测场景

### 4.1 短期验证
- 周期：2 周 ~ 1 个月
- 目的：快速验证逻辑正确性
- 关注：交易能否执行、基本收益为正

### 4.2 季度回顾
- 周期：3 个月
- 目的：评估策略季节性表现
- 关注：与季度基准对比

### 4.3 年度评估
- 周期：1 年
- 目的：全面评估策略有效性
- 关注：完整指标体系、超额收益、夏普比率

### 4.4 多年回测
- 周期：3 ~ 5 年
- 目的：验证策略稳健性
- 关注：不同市场周期表现、最大回撤控制

---

## 五、Funnel 选股流程指标

### 5.1 漏斗各阶段监控
| 阶段 | 过滤条件 | 监控点 | 状态 |
|------|----------|--------|------|
| Step 0 | 初始股票池 | 上市 > 180 天 | ✅ |
| Step 1 | 概念排名 | Top 3 概念 | ✅ |
| Step 2 | 流动性过滤 | 成交额 > 5000万/日 | ✅ |
| Step 3 | 威科夫波动率 | 60日波动率最低 30% | ✅ |
| Step 4 | 最终精选 | KSP Score Top 3 | ✅ |

### 5.2 Wyckoff 波动率参数
| 参数 | 说明 | 当前值 | 状态 |
|------|------|--------|------|
| `window` | 滚动窗口天数 | 60 天 | ✅ |
| `percentile` | 保留波动率分位 | 30% | ✅ |
| `min_history` | 最小历史要求 | 30 天（不足则跳过） | ✅ |

---

## 六、模块化架构

### 6.1 代码结构
```
stock/stock/backtest/
├── __init__.py          # 包入口
├── data_loader.py       # 数据加载与校验
├── analyzer.py          # 指标计算
├── reporter.py          # 报告生成
└── engine.py            # 主引擎
```

### 6.2 测试覆盖
- `tests/test_backtest_module.py` - 11 个测试用例

---

*文档版本: v1.1*
*最后更新: 2026-02-19*
